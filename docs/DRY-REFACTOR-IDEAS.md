# What DRY Refactors Would Look Like

This doc sketches concrete changes to make the codebase more DRY (Don’t Repeat Yourself). No need to do all of them; pick what fits.

---

## 1. Single source for XSLT config

**Problem:** The same long arrays are duplicated in `nw-app.js` and `web-app.js`:

```js
importSvgXsltHref: [ '../xslt/page2svg.xslt', '../xslt/page_from_2010-03-19.xslt', ... ],
exportSvgXsltHref: [ '../xslt/svg2page.xslt', '../xslt/sortattr.xslt', ... ],
```

**DRY approach:** Define once, reuse.

**New file `js/editor-config.js`:**

```js
/**
 * Single source for editor config shared by NW and web app.
 * @version (from VERSION or sync-version)
 */
window.EDITOR_XSLT_CONFIG = {
  importSvgXsltHref: [
    '../xslt/page2svg.xslt',
    '../xslt/page_from_2010-03-19.xslt',
    '../xslt/page2page.xslt',
    '../xslt/alto_v2_to_page.xslt',
    '../xslt/alto_v3_to_page.xslt'
  ],
  exportSvgXsltHref: [
    '../xslt/svg2page.xslt',
    '../xslt/sortattr.xslt',
    '../xslt/page_fix_xsd_sequence.xslt'
  ]
};
```

**In `html/index.html`:** Add `<script src="js/editor-config.js"></script>` before the app scripts (or load it from page-editor if you prefer).

**In `nw-app.js` and `web-app.js`:** Replace the inline arrays with:

```js
pageCanvas.setConfig(
  Object.assign(
    { getImageFromXMLPath: findImageFromPath, /* ... */ },  // nw-app
    window.EDITOR_XSLT_CONFIG
  )
);
```

So: one place to add/remove/reorder XSLTs; both apps stay in sync.

---

## 2. Version in one place (already partly done)

**Problem:** Version appears in many files: `VERSION`, `package.json`, `@version` in JS/CSS/HTML/PHP, and `version = '1.1.2'` in `page-canvas.js` / `svg-canvas.js`. You already have `scripts/sync-version.sh` to keep them in sync.

**DRY options:**

- **A) Keep current approach:** `VERSION` is source of truth; `sync-version.sh` propagates it. No code change; just run the script after bumps.
- **B) Runtime version from one global:** In one bootstrap script (or in `index.html`), set e.g. `window.PAGE_EDITOR_VERSION = '1.1.2';` (or read from a small `version.js` generated by the build). Then in `page-canvas.js` / `svg-canvas.js` use `version = window.PAGE_EDITOR_VERSION || '1.1.2';` and drop the literal. Other `@version` lines can stay for comments only and still be synced by the script.

So: either “single source + script” (current) or “single source + one global” for runtime.

---

## 3. Shortcut + save drawer state (single helper)

**Problem:** In `page-editor.js`, the shortcuts for `c`, `b`, `m`, `d` repeat the same “flush save” logic:

```js
if ( saveDrawerStateTimer ) { clearTimeout(saveDrawerStateTimer); saveDrawerStateTimer = null; }
if ( typeof saveDrawerStateNow === 'function' ) saveDrawerStateNow();
```

**DRY approach:** One helper that runs an action and flushes drawer state.

**In `page-editor.js`:**

```js
function runAndFlushDrawerState( action ) {
  if ( typeof action === 'function' ) action();
  else if ( typeof action === 'string' ) $(action).click();
  if ( saveDrawerStateTimer ) { clearTimeout(saveDrawerStateTimer); saveDrawerStateTimer = null; }
  if ( typeof saveDrawerStateNow === 'function' ) saveDrawerStateNow();
}

/// Single-key shortcuts: c=Create, b=Baseline, m=Margin, d=Default (persist mode immediately) ///
Mousetrap.bind( 'c', function () { runAndFlushDrawerState( '#createMode' ); return false; } );
Mousetrap.bind( 'b', function () { runAndFlushDrawerState( '#baseMode' ); return false; } );
Mousetrap.bind( 'm', function () { runAndFlushDrawerState( function () { applyBaselineTypeToSelected('margin'); } ); return false; } );
Mousetrap.bind( 'd', function () { runAndFlushDrawerState( function () { applyBaselineTypeToSelected('default'); } ); return false; } );
```

So: “click then flush” / “run fn then flush” lives in one place.

---

## 4. Drawer state save/load (radio vs checkbox vs text)

**Problem:** In `saveDrawerStateNow` and `loadDrawerState`, the logic for “checkbox → drawerState[id]”, “radio → drawerState[name] = label id”, “text → drawerState[id]” is repeated in two parallel blocks.

**DRY approach:** One loop that branches on input type, or a small map of “how to save/load” per type. Example shape:

```js
function serializeDrawerInput( $label ) {
  var input = $label.children('input').first();
  switch ( input.attr('type') ) {
    case 'checkbox': return { key: $label[0].id, val: input.prop('checked') };
    case 'radio':    return input.prop('checked') ? { key: input.attr('name'), val: $label[0].id } : null;
    case 'text':     return { key: $label[0].id, val: input.val() };
    default:         return null;
  }
}
function deserializeDrawerInput( $label, drawerState ) {
  var input = $label.children('input').first();
  // ... one place that sets .prop('checked') or .val() from drawerState
}
```

Then `saveDrawerStateNow` and `loadDrawerState` both iterate `$drawer.find('label')` and call these helpers. So: one definition of “how each input type is saved/loaded”.

---

## 5. Summary

| Area              | Change                                      | Benefit                          |
|-------------------|---------------------------------------------|----------------------------------|
| XSLT config       | One `editor-config.js`; nw-app + web-app use it | One place to edit XSLT lists     |
| Version           | Keep sync script; optional single runtime global | Fewer places to forget to bump   |
| Shortcuts c/b/m/d | `runAndFlushDrawerState( action )`          | No repeated flush logic          |
| Drawer state      | Shared serialize/deserialize helpers        | Same rules for save and load     |

You can apply 1, 3, and 4 without touching the build; 2 is optional and can stay as-is with the existing script.

---

## Reminder: Do not re-apply “orthogonal default/margin”

Making default/margin **orthogonal** (do not change the baseline-type radio when selecting a TextLine; do not force “default” on unselect) was implemented and then **reverted at user request**. Do **not** re-apply that behaviour: keep the current logic where selecting a line updates the default/margin radio to match that line, and where unselecting can set the radio to default when none is checked.
