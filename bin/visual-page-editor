#!/usr/bin/env bash
(set -o igncr) 2>/dev/null && set -o igncr; # ignore \r line endings

##
## Command line launcher for visual-page-editor.
## Compatible with Linux, macOS, and Windows (via Git Bash/WSL).
##
## @version 1.1.1
## @author buzzcauldron
## @copyright Copyright(c) 2025, buzzcauldron
## @license MIT License
## Based on nw-page-editor by Mauricio Villegas
##

# Detect platform and hardware architecture (for attuning NW.js version to machine)
OS="$(uname -s)"
case "${OS}" in
  Linux*)     PLATFORM="linux";;
  Darwin*)    PLATFORM="macos";;
  CYGWIN*)    PLATFORM="windows";;
  MINGW*)     PLATFORM="windows";;
  MSYS*)      PLATFORM="windows";;
  *)          PLATFORM="unknown";;
esac

# Set MAC_ARCH / WIN_ARCH / MACHINE_ARCH early so cache can be validated against hardware
MAC_ARCH=""
WIN_ARCH="x64"
MACHINE_ARCH="x64"
if [ "$PLATFORM" = "macos" ]; then
  MAC_ARCH=$(uname -m)
  case "$MAC_ARCH" in arm64|arm64e) MACHINE_ARCH="arm64";; *) MACHINE_ARCH="x64";; esac
elif [ "$PLATFORM" = "windows" ]; then
  if [ -n "${PROCESSOR_ARCHITECTURE:-}" ] && [ "$PROCESSOR_ARCHITECTURE" = "ARM64" ]; then WIN_ARCH="arm64"; MACHINE_ARCH="arm64"
  elif [ -n "${PROCESSOR_ARCHITEW6432:-}" ] && [ "$PROCESSOR_ARCHITEW6432" = "ARM64" ]; then WIN_ARCH="arm64"; MACHINE_ARCH="arm64"
  elif [ "$(uname -m 2>/dev/null)" = "aarch64" ]; then WIN_ARCH="arm64"; MACHINE_ARCH="arm64"
  fi
elif [ "$PLATFORM" = "linux" ]; then
  case "$(uname -m 2>/dev/null)" in aarch64|arm64) MACHINE_ARCH="arm64";; esac
fi

# Function to resolve script directory
readlinkf() { 
  if command -v perl >/dev/null 2>&1; then
    # Use argument instead of reading from stdin
    perl -MCwd -e 'my $path = shift @ARGV; $path =~ s/\s+$//; print Cwd::abs_path($path) . "\n";' "$1"
  elif command -v readlink >/dev/null 2>&1; then
    readlink -f "$1" 2>/dev/null || realpath "$1" 2>/dev/null || echo "$1"
  else
    echo "$1"
  fi
}

# Resolve application directory
if [ "${nw_page_editor:-}" = "" ]; then
  # Use readlinkf with proper error handling
  if [ -n "$0" ]; then
    SCRIPT_PATH=$(readlinkf "$0" 2>/dev/null || echo "$0")
  else
    SCRIPT_PATH="$0"
  fi
  # Ensure we got a valid path
  if [ -z "$SCRIPT_PATH" ]; then
    SCRIPT_PATH="$0"
  fi
  # Strip /bin/scriptname or \bin\scriptname from path
  # For Windows paths, need to escape backslashes properly in sed: \\ becomes \ in sed regex
  nw_page_editor=$(echo "$SCRIPT_PATH" | sed "s|/bin/${0##*/}$||" | sed "s|\\\\bin\\\\${0##*/}$||")
fi

[ ! -f "$nw_page_editor/js/nw-app.js" ] && [ -f "$nw_page_editor/share/nw-page-editor/js/nw-app.js" ] &&
  nw_page_editor="$nw_page_editor/share/nw-page-editor";

# NW.js version configuration (can be overridden via environment variable)
NWJS_VERSION="${NWJS_VERSION:-0.94.0}"

# Cache dir for resolved NW.js path (speeds up subsequent startups)
CACHE_DIR="${HOME}/.cache/visual-page-editor"
CACHE_FILE="${CACHE_DIR}/nw-path"

# Function to download NW.js automatically
download_nwjs() {
  local platform="$1"
  local arch="$2"
  local download_dir=""
  local nwjs_url=""
  local nwjs_archive=""
  local nwjs_extracted=""
  local nwjs_binary=""
  
  echo "${0##*/}: NW.js not found. Attempting to download automatically..." >&2
  
  # Determine download location (prefer user's home directory)
  if [ "$platform" = "macos" ]; then
    download_dir="$HOME/.nwjs"
    if [ "$arch" = "arm64" ]; then
      nwjs_url="https://dl.nwjs.io/v${NWJS_VERSION}/nwjs-sdk-v${NWJS_VERSION}-osx-arm64.zip"
      nwjs_archive="$download_dir/nwjs-sdk-v${NWJS_VERSION}-osx-arm64.zip"
      nwjs_extracted="$download_dir/nwjs-sdk-v${NWJS_VERSION}-osx-arm64"
      nwjs_binary="$nwjs_extracted/nwjs.app/Contents/MacOS/nwjs"
    else
      nwjs_url="https://dl.nwjs.io/v${NWJS_VERSION}/nwjs-sdk-v${NWJS_VERSION}-osx-x64.zip"
      nwjs_archive="$download_dir/nwjs-sdk-v${NWJS_VERSION}-osx-x64.zip"
      nwjs_extracted="$download_dir/nwjs-sdk-v${NWJS_VERSION}-osx-x64"
      nwjs_binary="$nwjs_extracted/nwjs.app/Contents/MacOS/nwjs"
    fi
  elif [ "$platform" = "linux" ]; then
    download_dir="$HOME/.nwjs"
    nwjs_url="https://dl.nwjs.io/v${NWJS_VERSION}/nwjs-sdk-v${NWJS_VERSION}-linux-x64.tar.gz"
    nwjs_archive="$download_dir/nwjs-sdk-v${NWJS_VERSION}-linux-x64.tar.gz"
    nwjs_extracted="$download_dir/nwjs-sdk-v${NWJS_VERSION}-linux-x64"
    nwjs_binary="$nwjs_extracted/nw"
  elif [ "$platform" = "windows" ]; then
    download_dir="$HOME/nwjs"
    if [ "$arch" = "arm64" ]; then
      nwjs_url="https://dl.nwjs.io/v${NWJS_VERSION}/nwjs-sdk-v${NWJS_VERSION}-win-arm64.zip"
      nwjs_archive="$download_dir/nwjs-sdk-v${NWJS_VERSION}-win-arm64.zip"
      nwjs_extracted="$download_dir/nwjs-sdk-v${NWJS_VERSION}-win-arm64"
      nwjs_binary="$nwjs_extracted/nw.exe"
    else
      nwjs_url="https://dl.nwjs.io/v${NWJS_VERSION}/nwjs-sdk-v${NWJS_VERSION}-win-x64.zip"
      nwjs_archive="$download_dir/nwjs-sdk-v${NWJS_VERSION}-win-x64.zip"
      nwjs_extracted="$download_dir/nwjs-sdk-v${NWJS_VERSION}-win-x64"
      nwjs_binary="$nwjs_extracted/nw.exe"
    fi
  else
    echo "${0##*/}: error: automatic download not supported for platform: $platform" >&2
    return 1
  fi
  
  # Check if curl or wget is available
  if ! command -v curl >/dev/null 2>&1 && ! command -v wget >/dev/null 2>&1; then
    echo "${0##*/}: error: curl or wget required for automatic download" >&2
    echo "  Please install curl or wget, or download NW.js manually from:" >&2
    echo "  $nwjs_url" >&2
    return 1
  fi
  
  # Create download directory
  mkdir -p "$download_dir" || {
    echo "${0##*/}: error: cannot create download directory: $download_dir" >&2
    return 1
  }
  
  # Check if already downloaded
  if [ -f "$nwjs_binary" ]; then
    echo "${0##*/}: Found existing NW.js at: $nwjs_binary" >&2
    echo "$nwjs_binary"
    return 0
  fi
  
  # Download NW.js
  echo "${0##*/}: Downloading NW.js v${NWJS_VERSION} from $nwjs_url..." >&2
  echo "${0##*/}: This may take a few minutes..." >&2
  
  if command -v curl >/dev/null 2>&1; then
    if ! curl -fLSs -o "$nwjs_archive" "$nwjs_url"; then
      echo "${0##*/}: error: failed to download NW.js" >&2
      rm -f "$nwjs_archive"
      return 1
    fi
  elif command -v wget >/dev/null 2>&1; then
    if ! wget -q --show-progress -O "$nwjs_archive" "$nwjs_url"; then
      echo "${0##*/}: error: failed to download NW.js" >&2
      rm -f "$nwjs_archive"
      return 1
    fi
  fi
  
  # Extract NW.js
  echo "${0##*/}: Extracting NW.js..." >&2
  if [ "$platform" = "macos" ] || [ "$platform" = "windows" ]; then
    # Use unzip for macOS and Windows
    if ! command -v unzip >/dev/null 2>&1; then
      echo "${0##*/}: error: unzip required for extraction" >&2
      rm -f "$nwjs_archive"
      return 1
    fi
    if ! unzip -q -o "$nwjs_archive" -d "$download_dir"; then
      echo "${0##*/}: error: failed to extract NW.js archive" >&2
      rm -f "$nwjs_archive"
      return 1
    fi
  else
    # Use tar for Linux
    if ! tar -xzf "$nwjs_archive" -C "$download_dir"; then
      echo "${0##*/}: error: failed to extract NW.js archive" >&2
      rm -f "$nwjs_archive"
      return 1
    fi
  fi
  
  # Clean up archive
  rm -f "$nwjs_archive"
  
  # Verify extraction
  if [ ! -f "$nwjs_binary" ]; then
    echo "${0##*/}: error: NW.js binary not found after extraction" >&2
    echo "  Expected: $nwjs_binary" >&2
    return 1
  fi
  
  # Make binary executable (Linux)
  if [ "$platform" = "linux" ]; then
    chmod +x "$nwjs_binary" 2>/dev/null || true
  fi
  
  echo "${0##*/}: NW.js downloaded and extracted successfully!" >&2
  echo "${0##*/}: Location: $nwjs_binary" >&2
  
  # For macOS, also create a symlink in /Applications if possible
  if [ "$platform" = "macos" ] && [ -d "$nwjs_extracted/nwjs.app" ]; then
    if [ -w "/Applications" ]; then
      local app_link="/Applications/nwjs-sdk-v${NWJS_VERSION}-${arch}.app"
      if [ ! -e "$app_link" ]; then
        ln -s "$nwjs_extracted/nwjs.app" "$app_link" 2>/dev/null && \
          echo "${0##*/}: Created symlink: $app_link" >&2 || true
      fi
    fi
  fi
  
  echo "$nwjs_binary"
  return 0
}

# Find NW.js binary: try cache first (only use if path + version + architecture match this machine)
nw=""
if [ -f "$CACHE_FILE" ]; then
  cached_path=$(head -n 1 "$CACHE_FILE" 2>/dev/null)
  cached_ver=$(sed -n '2p' "$CACHE_FILE" 2>/dev/null)
  cached_arch=$(sed -n '3p' "$CACHE_FILE" 2>/dev/null)
  if [ -n "$cached_path" ] && [ -f "$cached_path" ] && [ -x "$cached_path" ] && [ "$cached_ver" = "$NWJS_VERSION" ]; then
    # Attune to hardware: use cache only if cached binary matches current machine architecture
    arch_ok=1
    if [ -n "$cached_arch" ]; then
      [ "$cached_arch" != "$MACHINE_ARCH" ] && arch_ok=0
    else
      # No arch in cache: validate with file (e.g. avoid using x64 cache on Apple Silicon)
      if [ "$PLATFORM" = "macos" ] && [ "$MACHINE_ARCH" = "arm64" ]; then
        FILE_ARCH=$(file "$cached_path" 2>/dev/null | grep -i "arm64\|arm64e" || echo "")
        [ -z "$FILE_ARCH" ] && arch_ok=0
      elif [ "$PLATFORM" = "windows" ] && [ "$MACHINE_ARCH" = "arm64" ]; then
        case "$cached_path" in *arm64*) ;; *) arch_ok=0;; esac
      fi
    fi
    [ "$arch_ok" = 1 ] && nw="$cached_path"
  fi
fi

if [ ! -f "$nw" ]; then
# Find NW.js binary based on platform
if [ "$PLATFORM" = "macos" ]; then
  # macOS: Check fastest paths first (MAC_ARCH already set above) (no find/mdfind) to avoid slow startup
  # 1) ~/.nwjs (where the launcher downloads NW.js) - single file check
  if [ "$MAC_ARCH" = "arm64" ]; then
    nw="$HOME/.nwjs/nwjs-sdk-v${NWJS_VERSION}-osx-arm64/nwjs.app/Contents/MacOS/nwjs"
    [ ! -f "$nw" ] && nw="$HOME/.nwjs/nwjs-sdk-v${NWJS_VERSION}-osx-x64/nwjs.app/Contents/MacOS/nwjs"
  else
    nw="$HOME/.nwjs/nwjs-sdk-v${NWJS_VERSION}-osx-x64/nwjs.app/Contents/MacOS/nwjs"
  fi
  # 2) Fixed /Applications paths (no find)
  if [ ! -f "$nw" ]; then
    if [ "$MAC_ARCH" = "arm64" ]; then
      nw="/Applications/nwjs-sdk-v${NWJS_VERSION}-osx-arm64/nwjs.app/Contents/MacOS/nwjs"
      [ ! -f "$nw" ] && nw="/Applications/nwjs.app/Contents/MacOS/nwjs"
    else
      nw="/Applications/nwjs.app/Contents/MacOS/nwjs"
    fi
  fi
  # 3) find/mdfind only if still not found (slow)
  if [ ! -f "$nw" ]; then
    if [ "$MAC_ARCH" = "arm64" ]; then
      nw=$(find "$HOME/.nwjs" -path "*nwjs-sdk*arm64*/nwjs.app/Contents/MacOS/nwjs" -type f 2>/dev/null | head -n 1)
      [ ! -f "$nw" ] && nw=$(find "$HOME/.nwjs" -path "*nwjs-sdk*x64*/nwjs.app/Contents/MacOS/nwjs" -type f 2>/dev/null | head -n 1)
      [ ! -f "$nw" ] && nw=$(find /Applications -path "*nwjs-sdk*arm64*/nwjs.app/Contents/MacOS/nwjs" -type f 2>/dev/null | head -n 1)
    else
      nw=$(find "$HOME/.nwjs" -path "*nwjs-sdk*x64*/nwjs.app/Contents/MacOS/nwjs" -type f 2>/dev/null | head -n 1)
    fi
    [ ! -f "$nw" ] && nw=$(mdfind "kMDItemKind == 'Application' && kMDItemFSName == 'nwjs.app'" 2>/dev/null | head -n 1)"/Contents/MacOS/nwjs"
    [ ! -f "$nw" ] && nw=$(find /Applications -name "nwjs.app" -type d 2>/dev/null | head -n 1)"/Contents/MacOS/nwjs"
  fi
  # 4) PATH
  [ ! -f "$nw" ] && nw=$(which nwjs 2>/dev/null)
  [ ! -f "$nw" ] && nw=$(which nw 2>/dev/null)
  
  # Warn if using x64 on Apple Silicon (Rosetta is slower)
  if [ "$MAC_ARCH" = "arm64" ] && [ -f "$nw" ]; then
    FILE_ARCH=$(file "$nw" 2>/dev/null | grep -i "arm64\|arm64e" || echo "")
    if [ -z "$FILE_ARCH" ]; then
      echo "Note: Found x64 NW.js on Apple Silicon. It will run via Rosetta 2." >&2
      echo "      For better performance, install ARM64 version: nwjs-sdk-v*-osx-arm64.zip" >&2
    fi
  fi
elif [ "$PLATFORM" = "windows" ]; then
  # Windows: prefer native architecture (WIN_ARCH already set above) (ARM64 first on Windows ARM, then x64)
  if [ "$WIN_ARCH" = "arm64" ]; then
    [ ! -f "$nw" ] && [ -f "/c/Program Files/nwjs-arm64/nw.exe" ] && nw="/c/Program Files/nwjs-arm64/nw.exe"
    [ ! -f "$nw" ] && [ -d "$HOME/nwjs/nwjs-sdk-v${NWJS_VERSION}-win-arm64" ] && nw="$HOME/nwjs/nwjs-sdk-v${NWJS_VERSION}-win-arm64/nw.exe"
    [ ! -f "$nw" ] && nw=$(find "$HOME/nwjs" -path "*win-arm64*" -name "nw.exe" -type f 2>/dev/null | head -n 1)
  fi
  if [ ! -f "$nw" ]; then
    if [ -d "/c/Program Files/nwjs" ]; then
      nw="/c/Program Files/nwjs/nw.exe"
    elif [ -d "/c/Program Files (x86)/nwjs" ]; then
      nw="/c/Program Files (x86)/nwjs/nw.exe"
    elif [ -d "$HOME/nwjs" ]; then
      nw="$HOME/nwjs/nw.exe"
    else
      [ ! -f "$nw" ] && nw="$HOME/nwjs/nwjs-sdk-v${NWJS_VERSION}-win-x64/nw.exe"
      [ ! -f "$nw" ] && [ "$WIN_ARCH" = "arm64" ] && nw="$HOME/nwjs/nwjs-sdk-v${NWJS_VERSION}-win-arm64/nw.exe"
      [ ! -f "$nw" ] && nw=$(find "$HOME/nwjs" -name "nw.exe" -type f 2>/dev/null | head -n 1)
      [ ! -f "$nw" ] && nw=$(which nw.exe 2>/dev/null || which nw 2>/dev/null)
    fi
  fi
  # Warn if using x64 NW.js on Windows ARM64
  if [ "$WIN_ARCH" = "arm64" ] && [ -f "$nw" ]; then
    case "$nw" in *arm64*) ;; *)
      echo "Note: Using x64 NW.js on Windows ARM64. It will run via emulation." >&2
      echo "      For better performance, install ARM64 version: nwjs-sdk-v*-win-arm64.zip" >&2
      ;;
    esac
  fi
else
  # Linux and others: Check download directory first, then PATH
  [ ! -f "$nw" ] && nw="$HOME/.nwjs/nwjs-sdk-v${NWJS_VERSION}-linux-x64/nw"
  [ ! -f "$nw" ] && nw=$(find "$HOME/.nwjs" -name "nw" -type f -perm +111 2>/dev/null | head -n 1)
  [ ! -f "$nw" ] && nw=$(which nw 2>/dev/null || which nwjs 2>/dev/null)
fi
fi

# Validate paths
[ ! -f "$nw_page_editor/js/nw-app.js" ] &&
  echo "${0##*/}: error: unable to resolve the visual-page-editor app location" >&2 &&
  echo "  Tried: $nw_page_editor" >&2 &&
  exit 1;

# If NW.js not found, attempt automatic download
if [ ! -f "$nw" ]; then
  # Auto-download when curl/wget available (no prompt)
  if [ -t 0 ] && [ -t 1 ] || [ "${AUTO_DOWNLOAD_NWJS:-}" = "1" ] || [ "${AUTO_DOWNLOAD_NWJS:-}" = "yes" ] || [ "${AUTO_DOWNLOAD_NWJS:-}" = "true" ]; then
    if [ "$PLATFORM" = "macos" ]; then
      downloaded_nw=$(download_nwjs "$PLATFORM" "$MAC_ARCH")
    elif [ "$PLATFORM" = "linux" ]; then
      downloaded_nw=$(download_nwjs "$PLATFORM" "x64")
    elif [ "$PLATFORM" = "windows" ]; then
      downloaded_nw=$(download_nwjs "$PLATFORM" "${WIN_ARCH:-x64}")
    else
      downloaded_nw=""
    fi

    if [ -n "$downloaded_nw" ] && [ -f "$downloaded_nw" ]; then
      nw="$downloaded_nw"
    else
      echo "${0##*/}: error: unable to find or download the NW.js binary" >&2
      echo "  Platform: $PLATFORM" >&2
      echo "  Please install NW.js from https://nwjs.io/downloads/" >&2
      echo "  Or add NW.js to your PATH" >&2
      exit 1
    fi
  else
    echo "${0##*/}: error: unable to find the NW.js binary" >&2
    echo "  Platform: $PLATFORM" >&2
    echo "  Please install NW.js from https://nwjs.io/downloads/" >&2
    echo "  Or set AUTO_DOWNLOAD_NWJS=1 to enable automatic download" >&2
    exit 1
  fi
fi

# Help message
if [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
  echo "Description: Simple app for visual editing of Page XML files"
  echo "Usage: ${0##*/} [page.xml]+ [pages_dir]+ [--list pages_list]+ [--css file.css]+ [--js file.js]+"
  echo ""
  echo "Environment variables:"
  echo "  NWJS_VERSION       - NW.js version to download (default: ${NWJS_VERSION})"
  echo "  AUTO_DOWNLOAD_NWJS - Set to '1', 'yes', or 'true' to enable automatic download"
  echo ""
  echo "If NW.js is not found, the script will download it automatically."
  echo "Downloaded NW.js is stored in: ~/.nwjs (Linux/macOS) or ~/nwjs (Windows)"
  exit 0
fi

# Prepare arguments
argv=( --wd "$(pwd)" "$@" )
argv=("${argv[@]/#-l/--list}")
argv=("${argv[@]/#--/++}")

# Determine log file location
if [ "$PLATFORM" = "windows" ]; then
  LOG_FILE="${TMP:-/tmp}/visual-page-editor.log"
else
  LOG_FILE="/tmp/visual-page-editor.log"
fi

# Launch application with better error handling
EXIT_CODE=0
if [ "$PLATFORM" = "macos" ] && [ "$MAC_ARCH" = "arm64" ] && [ -f "$nw" ]; then
  FILE_ARCH=$(file "$nw" 2>/dev/null | grep -i "arm64\|arm64e" || echo "")
  if [ -z "$FILE_ARCH" ]; then
    # Using x64 on Apple Silicon: try once to find ARM64 (faster than x64 via Rosetta)
    ARM64_NW=$(find /Applications -path "*nwjs-sdk*arm64*/nwjs.app/Contents/MacOS/nwjs" -type f 2>/dev/null | head -n 1)
    [ ! -f "$ARM64_NW" ] && ARM64_NW=$(find "$HOME/.nwjs" -path "*arm64*/nwjs.app/Contents/MacOS/nwjs" -type f 2>/dev/null | head -n 1)
    if [ -n "$ARM64_NW" ] && [ -f "$ARM64_NW" ]; then
      nw="$ARM64_NW"
      echo "Using ARM64 NW.js: $nw" >&2
    else
      echo "" >&2
      echo "WARNING: x64 NW.js on Apple Silicon (Rosetta 2). Install ARM64 for faster startup." >&2
      echo "" >&2
    fi
  fi
fi

# Save resolved path and architecture to cache (attune version to hardware for next run)
if [ -f "$nw" ]; then
  CACHE_ARCH="$MACHINE_ARCH"
  if [ "$PLATFORM" = "macos" ]; then
    FILE_ARCH=$(file "$nw" 2>/dev/null | grep -i "arm64\|arm64e" || echo "")
    [ -n "$FILE_ARCH" ] && CACHE_ARCH="arm64" || CACHE_ARCH="x64"
  elif [ "$PLATFORM" = "windows" ]; then
    case "$nw" in *arm64*) CACHE_ARCH="arm64";; *) CACHE_ARCH="x64";; esac
  fi
  mkdir -p "$CACHE_DIR" 2>/dev/null && printf '%s\n%s\n%s\n' "$nw" "$NWJS_VERSION" "$CACHE_ARCH" > "$CACHE_FILE" 2>/dev/null || true
fi

# Resolve app path to absolute so NW.js receives a valid path
APP_PATH="$nw_page_editor"
if [ -d "$APP_PATH" ]; then
  case "$APP_PATH" in
    /*) ;;
    *) APP_PATH=$(cd "$APP_PATH" && pwd) || true ;;
  esac
fi

# On macOS, binary inside .app bundle often ignores first arg and looks for bundle's app.nw; use --nwapp= to force our app
NW_LAUNCH_ARGS=("$APP_PATH" "${argv[@]}")
if [ "$PLATFORM" = "macos" ] && case "$nw" in *".app/Contents/MacOS/"*) true;; *) false;; esac; then
  NW_LAUNCH_ARGS=("--nwapp=$APP_PATH" "${argv[@]}")
fi

# Launch with error trapping
set +e  # Don't exit on error, we'll handle it
"$nw" "${NW_LAUNCH_ARGS[@]}" 2>>"$LOG_FILE"
EXIT_CODE=$?
set -e  # Re-enable error exit

# Check exit code and provide helpful messages
if [ $EXIT_CODE -ne 0 ]; then
  echo "" >&2
  echo "${0##*/}: Application exited with error code $EXIT_CODE" >&2
  if [ -f "$LOG_FILE" ]; then
    echo "Check log file for details: $LOG_FILE" >&2
    echo "Last 10 lines of log:" >&2
    tail -10 "$LOG_FILE" >&2
  fi
  if [ "$PLATFORM" = "macos" ] && [ "$MAC_ARCH" = "arm64" ]; then
    echo "" >&2
    echo "Troubleshooting for Apple Silicon:" >&2
    echo "1. Ensure you're using ARM64 NW.js (not x64)" >&2
    echo "2. Download: nwjs-sdk-v*-osx-arm64.zip from https://nwjs.io/downloads/" >&2
    echo "3. Extract and move nwjs.app to /Applications/" >&2
    echo "4. Clear path cache and retry: rm -f $CACHE_FILE" >&2
    # Clear path cache so next run re-detects (may find ARM64 instead of cached x64)
    rm -f "$CACHE_FILE" 2>/dev/null || true
  fi
  echo "" >&2
  echo "See DEBUG.md section 'Project crashed' for more." >&2
fi

exit $EXIT_CODE